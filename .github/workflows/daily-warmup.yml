name: Daily & Post-Deploy Warmup

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 00:05 = UTC 16:05 (å‰ä¸€å¤©)
    - cron: '5 16 * * 0' # Weekly on Sunday at 16:05 UTC (00:05 Monday BJ Time)
  # å½“ Vercel éƒ¨ç½²çŠ¶æ€æ›´æ–°æ—¶è§¦å‘
  deployment_status:
  workflow_dispatch:

jobs:
  warmup:
    # é€»è¾‘ä¼˜åŒ–ï¼šåªåœ¨å®šæ—¶ä»»åŠ¡ã€æ‰‹åŠ¨è§¦å‘ æˆ– ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸæ—¶è¿è¡Œ
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'deployment_status' && 
       github.event.deployment_status.state == 'success' && 
       github.event.deployment.environment == 'Production')

    name: Dual-Region Warmup (US + Asia)
    runs-on: ubuntu-latest
    steps:
      - name: Wait for DNS/CDN Propagation
        if: github.event_name == 'deployment_status'
        run: sleep 60

      # --- 1. äºšæ´²åŒºåŸŸé¢„çƒ­ (Vercel API - æ—¥æœ¬èŠ‚ç‚¹) ---
      - name: Warmup Asia Edge (Vercel API)
        run: |
          echo "ğŸ‡¯ğŸ‡µ Triggering Asia warmup via Vercel API..."
          # Capture HTTP status and body
          response=$(curl -s -w "\n%{http_code}" "https://www.alok-rss.top/api/system/warmup")

          # Extract body and status (last line is status)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"

          if [ "$http_code" -eq 200 ]; then
            echo "$body" | jq .
            REGION=$(echo "$body" | jq -r '.ingressRegion // "unknown"')
            echo "âœ… Warmup completed from edge region: $REGION"
          else
            echo "âŒ Warmup Failed:"
            echo "$body"
            exit 1
          fi

      # --- 2. ç¾å›½åŒºåŸŸé¢„çƒ­ (GitHub Runner ç›´æ¥ Curl) ---
      # ä¼˜ç‚¹:
      # 1. è¦†ç›–å…¨ç«™: åŸºäº sitemap.xmlï¼ŒåŒ…å«é¦–é¡µã€å½’æ¡£ã€è¶‹åŠ¿ã€æ‰€æœ‰å†å²æ—¥æœŸ
      # 2. çœŸå®æ¨¡æ‹Ÿ: æ¨¡æ‹Ÿçˆ¬è™«è¡Œä¸ºï¼Œä»å¤–éƒ¨é€šè¿‡ sitemap å‘ç°å¹¶è®¿é—®é“¾æ¥
      # 3. æé€Ÿè½»é‡: çº¯ Shell (curl + awk)ï¼Œæ— éœ€å®‰è£… Node/pnpm
      - name: Warmup US Edge (Sitemap Strategy)
        run: |
          echo "ğŸ‡ºğŸ‡¸ Fetching sitemap.xml..."
          SITEMAP_URL="https://www.alok-rss.top/sitemap.xml"

          # 1. æŠ“å–å¹¶æå–æ‰€æœ‰ URL (<loc>æ ‡ç­¾)
          # ä½¿ç”¨ grep å’Œ sed æå– xml ä¸­çš„é“¾æ¥ï¼Œç®€å•é«˜æ•ˆ
          URLS=$(curl -s $SITEMAP_URL | grep "<loc>" | sed 's/.*<loc>\(.*\)<\/loc>.*/\1/')

          COUNT=$(echo "$URLS" | wc -l | xargs)
          echo "âœ… Found $COUNT pages in sitemap."

          # 2. å¹¶è¡Œé¢„çƒ­ (Shell å¾ªç¯)
          echo "$URLS" | while read url; do
            # è·³è¿‡ç©ºè¡Œ
            [ -z "$url" ] && continue
            
            echo "ğŸ”¥ Warming: $url"
            # å‘èµ·è¯·æ±‚ï¼Œä¸¢å¼ƒ bodyï¼Œåªæ‰“å°çŠ¶æ€ç 
            # -w "%{http_code}\n": æ‰“å°çŠ¶æ€ç 
            # -o /dev/null: ä¸¢å¼ƒå“åº”ä½“
            # -s: é™é»˜æ¨¡å¼
            # &: åå°è¿è¡Œå®ç°å¹¶å‘ (æ³¨æ„: GitHub Action èµ„æºæœ‰é™ï¼Œè¿™é‡Œçš„å¹¶å‘ä¸»è¦ä¸ºäº†åˆ©ç”¨ç½‘ç»œIOç­‰å¾…æ—¶é—´)
            curl -s -o /dev/null -w "Status: %{http_code} -> $url\n" "$url" &
            
            # ç®€å•çš„å¹¶å‘æ§åˆ¶: æ¯æ¬¡å¯åŠ¨è¯·æ±‚åçŸ­æš‚ sleepï¼Œé¿å…ç¬é—´å‡ ç™¾ä¸ªè¯·æ±‚è§¦å‘ WAF 429
            sleep 0.05
          done

          # ç­‰å¾…æ‰€æœ‰åå°ä»»åŠ¡å®Œæˆ
          wait
          echo "âœ… US Warmup / Sitemap Crawl Done"
