name: Daily & Post-Deploy Warmup

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 00:05 = UTC 16:05 (å‰ä¸€å¤©)
    - cron: '5 16 * * 0' # Weekly on Sunday at 16:05 UTC (00:05 Monday BJ Time)
  # å½“ Vercel éƒ¨ç½²çŠ¶æ€æ›´æ–°æ—¶è§¦å‘
  deployment_status:
  workflow_dispatch:

jobs:
  warmup:
    # é€»è¾‘ä¼˜åŒ–ï¼šåªåœ¨å®šæ—¶ä»»åŠ¡ã€æ‰‹åŠ¨è§¦å‘ æˆ– ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸæ—¶è¿è¡Œ
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'deployment_status' && 
       github.event.deployment_status.state == 'success' && 
       github.event.deployment.environment == 'Production')

    name: Dual-Region Warmup (US + Asia)
    runs-on: ubuntu-latest
    steps:
      - name: Wait for DNS/CDN Propagation
        if: github.event_name == 'deployment_status'
        run: sleep 60

      # --- 1. äºšæ´²åŒºåŸŸé¢„çƒ­ (Vercel API - æ—¥æœ¬èŠ‚ç‚¹) ---
      # --- 1. äºšæ´²åŒºåŸŸé¢„çƒ­ (Vercel API - ZH) ---
      - name: Warmup Asia Edge (ZH)
        run: |
          echo "ğŸ‡¯ğŸ‡µ Triggering Asia warmup (ZH) via Vercel API..."
          response=$(curl -s -w "\n%{http_code}" "https://www.alok-rss.top/api/system/warmup?lang=zh")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          if [ "$http_code" -eq 200 ]; then
            echo "$body" | jq .
          else
            echo "âŒ ZH Warmup Failed (Non-blocking)"
          fi

      # --- 2. ç¾å›½åŒºåŸŸé¢„çƒ­ (GitHub Runner - All) ---
      # (Existing step below...)

      # --- 2. ç¾å›½åŒºåŸŸé¢„çƒ­ (GitHub Runner ç›´æ¥ Curl) ---
      # ä¼˜ç‚¹:
      # 1. è¦†ç›–å…¨ç«™: åŸºäº sitemap.xmlï¼ŒåŒ…å«é¦–é¡µã€å½’æ¡£ã€è¶‹åŠ¿ã€æ‰€æœ‰å†å²æ—¥æœŸ
      # 2. çœŸå®æ¨¡æ‹Ÿ: æ¨¡æ‹Ÿçˆ¬è™«è¡Œä¸ºï¼Œä»å¤–éƒ¨é€šè¿‡ sitemap å‘ç°å¹¶è®¿é—®é“¾æ¥
      # 3. æé€Ÿè½»é‡: çº¯ Shell (curl + awk)ï¼Œæ— éœ€å®‰è£… Node/pnpm
      - name: Warmup US Edge (Sitemap Strategy)
        run: |
          echo "ğŸ‡ºğŸ‡¸ Fetching sitemap.xml..."
          START_TIME=$(date +%s%3N)
          SITEMAP_URL="https://www.alok-rss.top/sitemap.xml"

          # 1. æŠ“å–å¹¶æå–æ‰€æœ‰ URL
          # ä½¿ç”¨ grep å’Œ sed æå– xml ä¸­çš„é“¾æ¥
          URLS_CN=$(curl -s "https://www.alok-rss.top/sitemap.xml" | grep "<loc>" | sed 's/.*<loc>\(.*\)<\/loc>.*/\1/')
          URLS_EN=$(curl -s "https://www.alok-rss.top/en/sitemap.xml" | grep "<loc>" | sed 's/.*<loc>\(.*\)<\/loc>.*/\1/')

          # åˆå¹¶ URL åˆ—è¡¨
          URLS="$URLS_CN
          $URLS_EN"

          TOTAL=$(echo "$URLS" | wc -l | xargs)

          echo "Found $TOTAL pages in sitemap."

          # 2. å¹¶è¡Œé¢„çƒ­ & æ”¶é›†ç»“æœ (Race Condition Fix: ä½¿ç”¨ç‹¬ç«‹æ–‡ä»¶)
          # ä¸ºäº†é¿å…å¹¶å‘å†™å…¥å¯¼è‡´çš„ä¸¢è¡Œï¼Œæ¯ä¸ªè¯·æ±‚å†™å…¥ç‹¬ç«‹æ–‡ä»¶
          rm -f warmup_res_*.txt
          LOG_FILE="warmup_results.log"

          idx=0
          echo "$URLS" | while read url; do
            [ -z "$url" ] && continue
            idx=$((idx+1))
            
            # åå°æ‰§è¡Œ curlï¼Œç»“æœå†™å…¥ç‹¬ç«‹æ–‡ä»¶
            (
              http_code=$(curl -s -o /dev/null -w "%{http_code}" "$url")
              echo "{\"url\":\"$url\",\"status\":$http_code}" > "warmup_res_${idx}.txt"
            ) &
            
            # ç®€å•çš„å¹¶å‘æ§åˆ¶
            sleep 0.05
          done

          wait

          # åˆå¹¶æ‰€æœ‰ç»“æœ
          cat warmup_res_*.txt > $LOG_FILE
          rm -f warmup_res_*.txt

          # 3. ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š
          END_TIME=$(date +%s%3N)
          DURATION=$((END_TIME - START_TIME))

          SUCCESS_COUNT=$(grep -c '"status":200' $LOG_FILE || true)
          FAILED_COUNT=$(grep -vc '"status":200' $LOG_FILE || true)

          # æ„é€ ç±»ä¼¼ Vercel API çš„ JSON è¾“å‡º
          # ä»…æ˜¾ç¤ºå‰ 10 æ¡ç»“æœ
          RESULTS_PREVIEW=$(head -n 10 $LOG_FILE | jq -c -s '.')

          echo "âœ… US Warmup / Sitemap Crawl Done"

          # ä½¿ç”¨ jq æ„é€ æœ€ç»ˆ JSON å¹¶é€šè¿‡ echo è¾“å‡º
          jq -n \
            --arg msg "Warmed up $SUCCESS_COUNT/$TOTAL pages in ${DURATION}ms" \
            --arg exec "GitHub Runner (US)" \
            --arg ingress "sfo1 (Simulated)" \
            --argjson res "$RESULTS_PREVIEW" \
            --argjson total "$TOTAL" \
            --argjson success "$SUCCESS_COUNT" \
            --argjson failed "$FAILED_COUNT" \
            --argjson time "$DURATION" \
            '{
              success: true,
              message: $msg,
              executionRegion: $exec,
              ingressRegion: $ingress,
              note: "Results truncated to first 10 items for brevity. Check summary for total count.",
              results: $res,
              summary: {
                total: $total,
                success: $success,
                failed: $failed,
                totalTimeMs: $time
              }
            }'

      # --- 3. äºšæ´²åŒºåŸŸé¢„çƒ­ (Vercel API - EN) ---
      - name: Warmup Asia Edge (EN)
        run: |
          echo "ğŸ‡ºğŸ‡¸/ğŸ‡¯ğŸ‡µ Triggering Asia warmup (EN) via Vercel API..."
          response=$(curl -s -w "\n%{http_code}" "https://www.alok-rss.top/api/system/warmup?lang=en")
          http_code=$(echo "$response" | tail -n1)

          if [ "$http_code" -eq 200 ]; then
             echo "âœ… EN Warmup Triggered Success"
          else
             echo "âŒ EN Warmup Failed (Non-blocking)"
          fi
