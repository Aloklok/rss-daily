name: Daily & Post-Deploy Warmup

on:
  schedule:
    # 北京时间 00:05 = UTC 16:05 (前一天)
    - cron: '5 16 * * 0' # Weekly on Sunday at 16:05 UTC (00:05 Monday BJ Time)
  # 当 Vercel 部署状态更新时触发
  deployment_status:
  workflow_dispatch:

jobs:
  warmup:
    # 逻辑优化：只在定时任务、手动触发 或 生产环境部署成功时运行
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'deployment_status' && 
       github.event.deployment_status.state == 'success' && 
       github.event.deployment.environment == 'Production')

    name: Warm Up Recent Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile || npm install
        # Fallback to npm install if pnpm is not available in environment, though pnpm/action-setup is better.
        # Let's stick to simple npm install for scripts if possible, or setup pnpm.

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Wait for DNS/CDN Propagation
        if: github.event_name == 'deployment_status'
        run: sleep 60 # Increased to 60s for better propagation

      - name: Warm Up ALL History
        run: npx tsx scripts/warmup-all-history.ts
