name: Daily & Post-Deploy Warmup

on:
  schedule:
    # åŒ—äº¬æ—¶é—´ 00:05 = UTC 16:05 (å‰ä¸€å¤©)
    - cron: '5 16 * * 0' # Weekly on Sunday at 16:05 UTC (00:05 Monday BJ Time)
  # å½“ Vercel éƒ¨ç½²çŠ¶æ€æ›´æ–°æ—¶è§¦å‘
  deployment_status:
  workflow_dispatch:

jobs:
  warmup:
    # é€»è¾‘ä¼˜åŒ–ï¼šåªåœ¨å®šæ—¶ä»»åŠ¡ã€æ‰‹åŠ¨è§¦å‘ æˆ– ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸæ—¶è¿è¡Œ
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'deployment_status' && 
       github.event.deployment_status.state == 'success' && 
       github.event.deployment.environment == 'Production')

    name: Dual-Region Warmup (US + Asia)
    runs-on: ubuntu-latest
    steps:
      - name: Wait for DNS/CDN Propagation
        if: github.event_name == 'deployment_status'
        run: sleep 60

      # --- 1. äºšæ´²åŒºåŸŸé¢„çƒ­ (Vercel API - æ—¥æœ¬èŠ‚ç‚¹) ---
      - name: Warmup Asia Edge (Vercel API)
        run: |
          echo "ğŸ‡¯ğŸ‡µ Triggering Asia warmup via Vercel API..."
          RESULT=$(curl -s "https://www.alok-rss.top/api/system/warmup")
          echo "$RESULT" | jq .
          REGION=$(echo "$RESULT" | jq -r '.edgeRegion // "unknown"')
          echo "âœ… Warmup completed from edge region: $REGION"

      # --- 2. ç¾å›½åŒºåŸŸé¢„çƒ­ (GitHub Runner ç›´æ¥è®¿é—®) ---
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Warmup US Edge (Direct Script)
        run: |
          echo "ğŸ‡ºğŸ‡¸ Triggering US warmup via direct script..."
          npx tsx scripts/warmup-all-history.ts
