name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Job 1: 快速检查 (Fast Checks)
  # 包含所有的静态代码分析、类型检查和单元测试
  # 这些步骤运行速度快，可以并行执行
  check:
    name: Lint, Type Check & Unit Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint (ESLint)
        run: pnpm lint

      - name: Format Check (Prettier)
        run: pnpm prettier --check .

      - name: Type Check (TypeScript)
        # 确保没有 TypeScript 编译错误 (tsc)
        run: pnpm exec tsc --noEmit

      - name: Unit Tests (Vitest)
        run: pnpm test

  # Job 2: 端到端测试 (E2E Tests)
  # 只有在 check 任务成功后才运行
  # 因为这步比较慢，所以作为第二道防线
  e2e:
    name: Playwright E2E Tests
    needs: check
    timeout-minutes: 60
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.49.1-jammy # 使用包含浏览器的官方镜像加速
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Project Dependencies
        run: pnpm install --frozen-lockfile

      # 注意：因为使用了 container image，所以不需要 pnpm exec playwright install

      - name: Run E2E Tests
        run: pnpm test:e2e
        env:
          # CI 环境变量配置
          CI: true
          # Mock 数据需要的基本环境变量 (虽然我们用了 mockFullApp，但 Next.js 可能需要)
          NEXT_PUBLIC_SUPABASE_URL: 'https://mock.supabase.co'
          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'mock-key'
          # 确保测试用的 Token 与配置文件一致
          ACCESS_TOKEN: 'test-admin-token'

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
