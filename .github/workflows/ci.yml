name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/**' # Ignore workflow changes
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/**' # Ignore workflow changes

permissions:
  contents: read
  statuses: write

jobs:
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # --- 1. 静态检查 (Fail Fast) ---
      - name: Lint & Format Check
        run: pnpm lint
        continue-on-error: true

      - name: Type Check
        run: pnpm exec tsc --noEmit

      # --- 2. 单元测试 ---
      - name: Unit Tests (Vitest)
        run: pnpm test
        env:
          NEXT_PUBLIC_SUPABASE_URL: 'http://127.0.0.1:9999'
          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'mock-key'
          SUPABASE_URL: 'http://127.0.0.1:9999'
          SUPABASE_SERVICE_ROLE_KEY: 'mock-service-role-key'
          FRESHRSS_API_URL: 'http://127.0.0.1:9999/api/greader.php'
          FRESHRSS_AUTH_TOKEN: 'mock-token'
          ACCESS_TOKEN: 'test-admin-token'
          NEXT_DISABLE_CACHE: '1'

      # --- 3. 构建步骤 ---
      - name: Build Application
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: 'http://127.0.0.1:9999'
          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'mock-key'
          SUPABASE_URL: 'http://127.0.0.1:9999'
          SUPABASE_SERVICE_ROLE_KEY: 'mock-service-role-key'
          SENTRY_AUTH_TOKEN: 'mock-token'

      # --- 4. 端到端测试 ---
      - name: Run E2E Tests
        run: pnpm test:e2e
        env:
          CI: true
          NEXT_PUBLIC_SUPABASE_URL: 'http://127.0.0.1:9999'
          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'mock-key'
          SUPABASE_URL: 'http://127.0.0.1:9999'
          SUPABASE_SERVICE_ROLE_KEY: 'mock-service-role-key'
          FRESHRSS_API_URL: 'http://127.0.0.1:9999/api/greader.php'
          FRESHRSS_AUTH_TOKEN: 'mock-token'
          ACCESS_TOKEN: 'test-admin-token'
          HOME: /root

      # --- 5. 结果处理 ---
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      # --- 6. 通知 Vercel (关键步骤) ---
      - name: Notify Vercel Check Passed
        if: success()
        uses: 'vercel/repository-dispatch/actions/status@v1'
        with:
          # 必须和你刚才在 Vercel 网页里填写的 Check Name 完全一致
          name: 'Vercel - alok-rss-daily: checkALL'
