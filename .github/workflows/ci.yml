name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # Merged Job: 包含 Lint, Unit Test 和 E2E
  # 使用 Playwright 官方容器作为唯一的运行环境，避免重复安装依赖和启动开销
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 60
    container:
      image: mcr.microsoft.com/playwright:v1.57.0-jammy
      options: --user 1001 # 尝试以非 root 运行（可选），但 Playwright 容器默认通常是 root 或 pwuser
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      # --- 静态检查 & 单元测试 ---

      - name: Lint (ESLint)
        run: pnpm lint

      - name: Format Check (Prettier)
        run: pnpm prettier --check .

      - name: Type Check (TypeScript)
        run: pnpm exec tsc --noEmit

      - name: Unit Tests (Vitest)
        run: pnpm test
        env:
          NEXT_PUBLIC_SUPABASE_URL: 'http://127.0.0.1:9999'
          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'mock-key'
          SUPABASE_URL: 'http://127.0.0.1:9999'
          SUPABASE_SERVICE_ROLE_KEY: 'mock-service-role-key'
          FRESHRSS_API_URL: 'http://127.0.0.1:9999/api/greader.php'
          FRESHRSS_AUTH_TOKEN: 'mock-token'
          ACCESS_TOKEN: 'test-admin-token'
          NEXT_DISABLE_CACHE: '1'

      # --- 端到端测试 ---

      - name: Run E2E Tests
        run: pnpm test:e2e
        env:
          CI: true
          # Mock Data & Env
          NEXT_PUBLIC_SUPABASE_URL: 'http://127.0.0.1:9999'
          NEXT_PUBLIC_SUPABASE_ANON_KEY: 'mock-key'
          SUPABASE_URL: 'http://127.0.0.1:9999'
          SUPABASE_SERVICE_ROLE_KEY: 'mock-service-role-key'
          FRESHRSS_API_URL: 'http://127.0.0.1:9999/api/greader.php'
          FRESHRSS_AUTH_TOKEN: 'mock-token'
          ACCESS_TOKEN: 'test-admin-token'
          # Firefox Permission Fix
          HOME: /root

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
