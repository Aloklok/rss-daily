# 项目任务清单 (TODO)

本文档用于记录项目中待优化的技术点、备选架构方案以及已知的技术债。

> [!IMPORTANT]
> **开发核心准则 (Core Principle)**:
>
> 1. **SEO 第一**: 任何性能优化必须以不损害搜索引擎爬虫抓取为前提。
> 2. **首屏无 JS 渲染能力**: 必须保证核心内容（正文、目录链接、元数据等）在浏览器禁用 JS 的情况下依然能够通过 SSR/ISR 阻塞式呈现。

---

## 📋 待处理事项概览

### 🚀 性能提升与技术优化

- [ ] **图片自适应代理**: 通过 Edge Runtime 动态压缩/缩放外链图片，节省 80%+ 流量。改动难度：中，性能提升：高。
- [ ] **API 响应聚合**: 合并文章详情与 FreshRSS 状态接口，消除取数时的 Waterfall 瀑布效应，减少网络往返。改动难度：中，性能提升：中。
- [ ] **自愈机制抖动**: 为后台同步请求增加 0-2s 随机延迟 (Jitter)，应对大流量时的惊群效应，保护服务器。改动难度：低，性能提升：低（侧重稳定性）。
- [ ] **构建日志监控**: 持续观察最近 7 天的构建压力。若超时风险增加，进一步收缩 `generateStaticParams` 范围。改动难度：低，性能提升：中（降低构建耗时）。

### 🛡️ 安全审计与路由保护

- [ ] **API 速率限制**: 为重验与重放接口设置 IP 级的频率限制，防止恶意碎冰或滥用 AI 翻译资源。改动难度：中，性能提升：低（侧重稳定性）。
- [ ] **类型安全强化**: 将 `any` 类型声明替换为 Supabase 自动生成的强类型，实现全链路 Type-Safe。改动难度：中，性能提升：无（侧重代码质量）。

### 🧪 自动化测试与质量

- [ ] **E2E 边界稳定性**: 完善 Playwright Mock 系统，模拟 500/404 及弱网环境，验证 UI 鲁棒性。改动难度：中，性能提升：无。
- [ ] **功能测试补齐**: 补充对“全站搜索”、“无限滚动”以及“移动端侧边栏”交互的自动化覆盖。改动难度：中，性能提升：无。
- [ ] **SEO 自动化扫描**: 验证各日期页面的 Canonical URL、JSON-LD 及 Meta 数据在 ISR 构建后的一致性。改动难度：低，性能提升：无。

### ✨ 功能与体验迭代

- [ ] **悬停内容预取**: 在文章卡片的《阅读》按钮悬停时，针对性预取该文章全文，实现“秒开”体感。改动难度：低，性能提升：中。
- [ ] **语义向量搜索**: 启用 Supabase pgvector，支持“基于含义”而非仅“关键词”的搜索体验。改动难度：中，性能提升：无。
- [ ] **列表虚拟化**: 在文章列表极长时引入虚拟滚动，确保移动端 60fps 滚动。改动难度：低，性能提升：中。
- [ ] **翻译质量对账**: 定期抽检 NASA 天文等特定高密源的翻译结果，微调 Prompt 规则以优化翻译体感并节省 Token。改动难度：低，性能提升：无（优化内容质量）。
- [ ] **移动端离线体感**: 优化 Service Worker 或持久化策略，提升弱网下的数据暂存体验。改动难度：高，性能提升：高（极大优化弱网体感）。

### 🔄 架构备选方案

- [ ] **FreshRSS 客户端渲染回归**: 若 SSR 压力过大或 FreshRSS 响应极慢，准备好将 `BriefingClient` 切换回纯客户端 Fetch 模式。改动难度：中，性能提升：中（缩短白屏时间，但引入 UI 闪烁）。

---

## 1. 性能提升与技术优化

### 画像自适应代理

- **背景**: RSS 源的图片大小不一且未经优化，是 LCP 指标的最大痛点。
- **TODO**: 引入 Edge Runtime 图片代理，根据视口尺寸动态下发 WebP 格式图片，大幅节省带宽。改动难度：中，性能提升：高。

### API 响应聚合

- **现状**: 在 `services/articleLoader.ts` 中，获取文章后需再次请求获取状态（存在依赖瀑布流）。
- **TODO**: 考虑在底层 API 层面支持批量一次性返回“文章详情+FreshRSS状态”，减少一次往返次数。该优化不影响 SEO，且完全不具破坏性，仅纯逻辑层面的合并。

### 自愈机制抖动

- **背景**: 为了防止极端大流量情况下，多个客户端同时触发服务器碎冰（惊群效应）。
- **TODO**: 为 `useArticleStateHydration` 中的重验请求增加随机抖动时间（如 0-2000ms），让系统在高并发下更稳健。

### 构建日志监控

- **TODO**: 进一步监控 Vercel 构建日志。如果预生成 7 天数据依然导致超时，可考虑将其降至 3 天。同时探索图片 CDN 的进一步压缩策略。

---

## 2. 安全审计与路由保护

### API 速率限制

- **TODO**: 为 `/api/system/revalidate` 和 `/api/system/revalidate-date` 增加 IP 频率限制，防止恶意碎冰攻击或频繁调用导致的 FreshRSS 负载过热。

### 类型安全强化

- **现状**: 目前部分字段使用了 `any`。
- **TODO**: 逐步通过 `gen:supabase-types` 完善全流程的强类型检查，消除潜在的运行时类型错误。

---

## 3. 自动化测试与质量

### E2E 边界稳定性增强

- **现状**: `article.spec.ts` 已经初步由于 Mock 了 API 而稳定，但仍需加强。
- **TODO**:
  - 完善 `e2e/utils/mock-api.ts` 以支持更多边界情况（如 API 500/404）。
  - **🛡️ 错误状态**: 拦截 API 返回错误，验证错误提示 UI (Toast/Error Page) 及重试按钮功能。

### 功能测试补齐

- **TODO**:
  - 为“全站搜索”编写专用的 E2E 测试用例。
  - 增加对“移动端侧边栏”交互性测试。
  - **📱 移动端深度体验**: 增加触摸手势 (Swipe) 测试，验证虚拟键盘弹出时的 UI 适配。
  - **⚡️ 无限滚动**: 模拟滚动到底部，验证分页请求及 DOM 节点追加。

### SEO 自动化扫描

- **TODO**: **🔍 SEO 验证**: 抓取页面 `<head>`，验证 Canonical URL 及 JSON-LD 结构化数据是否生成正确。

---

## 4. 功能与体验迭代

### 悬停内容预取

- **背景**: 目前点击“阅读”后才开始 Fetch 文章全文，存在明显的加载过程。
- **TODO**:
  - 仅监听 **《阅读》按钮** 的悬停事件，当鼠标停留超过 150ms 时，精准触发该特定文章的全文 Fetch。
  - **精准控制**: 严格限制为单篇文章粒度，严禁触发列表级大批量预取，防止滥用用户流量及服务器资源。
- **改动难度**: 低，**性能提升**: 中。

### 语义向量搜索

- **背景**: 目前搜索基于关键词匹配，对“同义词”或“概念”搜索能力较弱。
- **TODO**: 启用 Supabase pgvector，将文章摘要转换为向量。用户搜“AI 绘图”即使文章只有“Midjourney”字样也能被搜到。改动难度：中，性能提升：无。

### 列表虚拟化

- **背景**: 极端情况下（如突发新闻日）文章瀑布流可能超过 100 项。
- **TODO**: 引入 `tanstack-virtual` 仅渲染可视区域，保持滚动流畅度。改动难度：低，性能提升：中。

### 翻译质量提升

- **TODO**: 针对 `PROMPT.MD` 中的规则更新（如 NASA 天文直接翻译），定期抽检生成结果并微调节省 Prompt。

### 移动端离线体感

- **TODO**: 优化 Service Worker 或引入简单的离线持久化策略 (如 IndexedDB)，提升在网络波动下的文章阅读连贯性。

---

## 5. 架构备选方案

### FreshRSS 客户端渲染回归

- **背景**: 目前采用“服务端预取 + 三级同步”模式。虽然解决了闪烁，但在“碎冰”后的首次访问会有约 0.5s-1s 的构建延迟。
- **TODO**: 如果未来用户对首屏加载速度（白屏时间）极其敏感，或 FreshRSS 服务端响应极慢导致 SSR 超时，可考虑将 `BriefingClient` 改回纯客户端获取模式。
- **改回方法**:
  - 删除 `app/page.tsx` 和 `app/date/[date]/page.tsx` 中的 `fetchArticleStatesServer`。
  - 将 `useArticleStateHydration` 的逻辑改为完全不依赖 `initialArticleStates`，始终强制执行客户端 Fetch。

---

## ✅ 已完成优化与确认事项

- [x] **数据库 RLS 审计**: 确认所有表策略已就绪，并修复了 `search_path` 漏洞。
- [x] **CDN 自动预热**: 实现 Webhook 触发后的自动页面访问，消除构建延迟。
- [x] **Bundle Size 优化**: 确认 `sanitize-html` 仅在服务端运行，减小首屏体积。
- [x] **三级状态同步**: 实现服务端预取、客户端挂载、后台自愈的闭环逻辑。
- [x] **按日期精准碎冰**: 实现带日期标签的缓存清理，提升命中率。
- [x] **构建性能优化**: 限制 `generateStaticParams` 仅生成最近 7 天数据。
- [x] **ISR 策略升级**: 将缓存有效期从 24 小时提升至 7 天。

---

> [!NOTE]
> 为保证文档清晰，“已完成”事项将始终置于底部。详细的 TODO 描述保留在中间各章节中，作为未来修改的入口参考。
