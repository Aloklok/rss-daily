# 项目任务清单 (TODO)

本文档用于记录项目中待优化的技术点、备选架构方案以及已知的技术债。

> [!IMPORTANT]
> **开发核心准则**:
>
> 1. **SEO 第一**: 任何性能优化必须以不损害搜索引擎爬虫抓取为前提。
> 2. **首屏无 JS 渲染能力**: 必须保证核心内容（正文、目录链接、元数据等）在浏览器禁用 JS 的情况下依然能够通过 SSR/ISR 阻塞式呈现。

---

## 📋 待处理事项概览

### 🚀 性能提升与技术优化

- [ ] **自愈机制抖动**: 为后台同步请求增加 0-2s 随机延迟 (Jitter)，应对大流量时的惊群效应，保护服务器。改动难度：低，性能提升：低（侧重稳定性）。
- [ ] **构建日志监控**: 持续观察最近 7 天的构建压力。若超时风险增加，进一步收缩 `generateStaticParams` 范围。改动难度：低，性能提升：中（降低构建耗时）。
- [ ] **DataFetcher 拆分**: `lib/server/dataFetcher.ts` 职责过重（~400行），建议拆分为 `briefingFetcher.ts` 和 `articleFetcher.ts`，提升文件可维护性。改动难度：低，性能提升：无。

### 🛡️ 安全审计与路由保护

- [ ] **API 速率限制**: 为重验与重放接口设置 IP 级的频率限制，防止恶意碎冰或滥用 AI 翻译资源。改动难度：中，性能提升：低（侧重稳定性）。
- [ ] **类型安全强化**: 将 `any` 类型声明替换为 Supabase 自动生成的强类型，实现全链路 Type-Safe。改动难度：中，性能提升：无（侧重代码质量）。

### 🧪 自动化测试与质量

- [ ] **E2E 边界稳定性**: 完善 Playwright Mock 系统,模拟 500/404 及弱网环境,验证 UI 鲁棒性。改动难度:中,性能提升:无。
- [ ] **状态同步 E2E 测试**: 完成 `e2e/tests/aggregation.spec.ts` (当前已跳过),验证"确认更新策略"、零冗余请求、定向缓存清除及刷新持久化。需解决 Mock 环境下的按钮定位问题。改动难度:中,性能提升:无。
- [ ] **功能测试补齐**: 补充对"全站搜索"、"无限滚动"以及"移动端侧边栏"交互的自动化覆盖。改动难度:中,性能提升:无。
- [ ] **SEO 自动化扫描**: 验证各日期页面的 Canonical URL、JSON-LD 及 Meta 数据在 ISR 构建后的一致性。改动难度：低，性能提升：无。
- [ ] **向量索引优化 (HNSW)**: 当文章数量达到 20k+ 时，重新开启 HNSW 索引以维持毫秒级检索延迟（目前 1k+ 数据全表扫描更快且更准）。

### ✨ 功能与体验迭代

- [ ] **悬停内容预取**: 在文章卡片的《阅读》按钮悬停时，针对性预取该文章全文，实现“秒开”体感。改动难度：低，性能提升：中。
- [ ] **列表虚拟化**: 在文章列表极长时引入虚拟滚动，确保移动端 60fps 滚动。改动难度：低，性能提升：中。
- [ ] **翻译质量对账**: 定期抽检 NASA 天文等特定高密源的翻译结果，微调 Prompt 规则以优化翻译体感并节省 Token。改动难度：低，性能提升：无（优化内容质量）。
- [ ] **移动端离线体感**: 优化 Service Worker 或持久化策略，提升弱网下的数据暂存体验。改动难度：高，性能提升：高（极大优化弱网体感）。

### 🔄 架构备选方案

- [ ] **Edge 聚合中间层 (BFF)**: 在 Vercel Edge Function 上实现轻量级聚合端点，一次性完成 Storage 检查、DB 读取和 Metadata 组装，合并跨洋 RTT。改动难度：高，性能提升：高（显著减少冷启动 RTT，适合全球化部署）。

---

## 🛠 详细说明 (待处理)

### 自愈机制抖动

- **TODO**: 为 `useArticleStateHydration` 中的重验请求增加随机抖动时间（如 0-2000ms），防止高并发下的“惊群效应”。

### API 速率限制

- **TODO**: 为 `/api/system/revalidate` 和 `/api/system/revalidate-date` 增加 IP 频率限制，防止恶意滥用 AI 资源。

### 功能测试补齐

- **TODO**: 为“全站搜索”编写专用的 E2E 测试用例；增加对“移动端侧边栏”交互性测试及“无限滚动”分页测试。

### 悬停内容预取

- **TODO**: 仅监听 **《阅读》按钮** 的悬停事件，当鼠标停留超过 150ms 时，精准触发该文章的全文 Fetch，实现秒开。

---

## ✅ 已完成优化 (Milestones)

- [x] **混合语义搜索**: 启用 Supabase pgvector (768 维)，实现了高效的“关键词+语义”双路召回。
- [x] **CDN 自动预热**: 实现 Webhook 触发后的自动页面访问，消除了 ISR 首次访问的构建延迟。
- [x] **Bundle Size 优化**: 严格限制 `sanitize-html` 仅在服务端运行，显著减小了首屏 JS 体积。
- [x] **图片自适应代理**: 通过 Weserv.nl 动态压缩外链图片，节省了 80%+ 的用户流量。
- [x] **API 响应聚合 (详情页优化)**: 在详情页通过 `include_state` 参数合并获取正文与 FreshRSS 状态，消除了详情加载时的瀑布流。_(注：列表流已切换至 Scheme C 异步水合，该优化现专注于阅读器体验)_。
