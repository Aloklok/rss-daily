# 基础设施架构文档

## 服务分布图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户请求流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                        🧑‍💻 用户 (中国大陆)
                              │
                              ▼ DNS 解析
                    ┌─────────────────────┐
                    │   Cloudflare CDN    │ ← 全球边缘节点
                    │   (东京 NRT Edge)   │    自动就近路由
                    └─────────┬───────────┘
                              │
              ┌───────────────┼───────────────┐
              ▼               ▼               ▼
     ┌────────────┐   ┌────────────┐   ┌────────────┐
     │  静态资源   │   │  API 请求   │   │  图片资源   │
     │  HTML/CSS  │   │  /api/*    │   │  /images   │
     └─────┬──────┘   └─────┬──────┘   └─────┬──────┘
           │                │                │
           ▼                ▼                ▼
    ┌────────────┐   ┌────────────┐   ┌────────────────┐
    │   Vercel   │   │   Vercel   │   │   阿里云 OSS   │
    │ Edge Cache │   │ Serverless │   │  (自建存储)    │
    │  (东京)    │   │ (多伦多)   │   │   ↓            │
    └────────────┘   └─────┬──────┘   │  Cloudflare    │
                           │          │  CDN 加速      │
              ┌────────────┴──────────┴────────────────┐
              │           后端服务调用                  │
              └────────────┬──────────┬────────────────┘
                           │          │
              ┌────────────┴──┐   ┌───┴────────────┐
              ▼               ▼   ▼                ▼
      ┌────────────┐   ┌────────────┐   ┌────────────┐
      │  Supabase  │   │  FreshRSS  │   │   Zeabur   │
      │  (韩国)    │   │  (美国)    │   │  (待迁移)  │
      │  数据库    │   │  用户状态  │   │  ↓         │
      │            │   │            │   │  印尼?     │
      └────────────┘   └────────────┘   └────────────┘
```

---

## 服务位置详情

| 服务         | 提供商            | 位置              | 用途             | 延迟 (从中国) |
| ------------ | ----------------- | ----------------- | ---------------- | ------------- |
| **前端托管** | Vercel            | 全球 (Edge: 东京) | SSR/ISR 页面渲染 | ~30ms ✅      |
| **CDN**      | Cloudflare        | 全球 (Edge: 东京) | 静态资源缓存     | ~30ms ✅      |
| **数据库**   | Supabase          | 🇰🇷 韩国首尔       | 文章数据存储     | ~80ms ✅      |
| **用户状态** | FreshRSS (Zeabur) | 🇺🇸 美国加州       | 已读/星标状态    | ~1700ms ❌    |
| **图片存储** | 阿里云 OSS        | 🇨🇳 中国           | 封面图/AI 生成图 | ~20ms ✅      |
| **图片 CDN** | Cloudflare        | 全球              | OSS 加速         | ~30ms ✅      |

---

## 延迟分析

### 当前瓶颈: FreshRSS

```
中国大陆 → Vercel Edge (东京) → FreshRSS (美国加州)
           └── ~30ms ──────────── ~1700ms ─────┘
                                      ↑
                                  跨太平洋!
```

**问题**: FreshRSS 部署在 Zeabur 美国节点,距离太远

---

## Zeabur 印尼节点分析

### 🤔 印尼节点可行吗?

**地理距离对比**:

| 路径              | 距离      | 预估延迟          |
| ----------------- | --------- | ----------------- |
| 东京 → 美国加州   | ~8,900 km | ~1700ms (实测)    |
| 东京 → 印尼雅加达 | ~5,800 km | ~200-400ms (估算) |

**结论**: **印尼比美国近很多,值得尝试!**

### 收益预估

- **当前** (美国): ~1700ms
- **迁移后** (印尼): ~200-400ms
- **预期改善**: **-75% ~ -88%**

### 建议

✅ **推荐迁移到印尼节点**:

- 距离缩短 ~3,000 km
- 延迟预计降低 1000ms+
- Zeabur 免费/低成本

---

## 完整网络拓扑

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          地理位置示意图                                  │
└─────────────────────────────────────────────────────────────────────────┘

                          🇺🇸 美国加州
                          FreshRSS (Zeabur)
                          Santa Clara
                               │
                               │ ~8,900 km ❌
                               │
    🇨🇦 加拿大多伦多 ←─────────┼─────────→ 🇯🇵 日本东京
    Vercel Serverless         │           Vercel Edge
                              │           Cloudflare Edge
                              │                │
                              │                │ ~30ms ✅
                              │                │
                              │           🇨🇳 中国大陆
                              │              用户
                              │                │
                              │                │ ~80ms ✅
    🇮🇩 印尼雅加达 ←──────────┴────────────────┴──→ 🇰🇷 韩国首尔
    FreshRSS (待迁移)                              Supabase
    Zeabur 新节点                                  数据库
```

---

## 优化路线图

### 当前状态

- ✅ **Supabase (韩国)**: 延迟 ~80ms,无需优化
- ✅ **Vercel Edge (东京)**: 自动就近路由,无需优化
- ✅ **阿里云 OSS + Cloudflare**: 图片加载极速
- ❌ **FreshRSS (美国)**: 延迟 ~1700ms,需要优化

### 建议方案

#### 短期: 迁移 FreshRSS 到印尼

**步骤**:

1. 在 Zeabur 创建新项目,选择印尼区域
2. 部署 FreshRSS 镜像
3. 迁移数据 (导出/导入订阅)
4. 更新 `FRESHRSS_API_URL` 环境变量
5. 验证延迟改善

**预期效果**: 1700ms → **~300ms** (-82%)

#### 长期: 完全摆脱 FreshRSS

**方案**: 将用户状态存储迁移到 Supabase (韩国)

**优势**:

- Supabase 已在韩国,延迟 ~80ms
- 统一数据存储,简化架构
- 完全控制数据模型

---

## 环境变量参考

```bash
# Supabase (韩国)
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=xxx

# FreshRSS (待迁移到印尼)
FRESHRSS_API_URL=https://aloklok-freshrss.zeabur.app/api
FRESHRSS_AUTH_TOKEN=xxx

# Vercel
NEXT_PUBLIC_BASE_URL=https://www.alok-rss.top

# 阿里云 OSS
ALIYUN_OSS_ENDPOINT=xxx.oss-cn-xxx.aliyuncs.com
ALIYUN_OSS_BUCKET=xxx
```

---

## 总结

| 组件         | 当前位置  | 延迟      | 优化建议       |
| ------------ | --------- | --------- | -------------- |
| Vercel       | 东京 Edge | ✅ 30ms   | 无需优化       |
| Cloudflare   | 东京 Edge | ✅ 30ms   | 无需优化       |
| Supabase     | 韩国首尔  | ✅ 80ms   | 无需优化       |
| 阿里云 OSS   | 中国      | ✅ 20ms   | 无需优化       |
| **FreshRSS** | 美国加州  | ❌ 1700ms | **迁移到印尼** |

**核心改进**: 将 FreshRSS 从美国迁移到印尼,预计延迟降低 **80%+**
