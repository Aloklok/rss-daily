# 安全设计与审计策略 (Security Design & Audit Strategy)

简报系统采用多层安全防御与审计策略，重点在于高精度的威胁检测与 SEO 健康监测，屏蔽无效噪音。

## 1. 边缘代理层 (`src/proxy.ts`)

`proxy` 函数（原 `middleware`）是系统的第一道防线。

### 机器人管理策略 (精简审计 - Lean Audit)

为了确保审计日志具有高信噪比，我们实施了**选择性审计**政策：

- **静默放行 (Silent Bypass)**：识别合法的工具类机器人（如 Sentry, Vercel, Uptime 监控等）并直接放行。这些请求**不记录日志**，也不触发安全校验。
- **精准拦截**：
  - **恶意路径扫描**：对针对敏感路径（`.env`, `wp-admin`, `.git` 等）的请求立即执行 403 拦截。
  - **UA 校验**：拦截 User-Agent 为空或过短（少于 10 字符）的脚本请求。
  - **限制型爬虫**：根据特征码拦截高频 SEO 爬虫和 AI 训练机器人。

## 2. 服务端审计日志 (`bot-logger.ts`)

日志持久化存储在 Supabase 中，供管理员审计。

### 审计目标

- **安全拦截记录 (403)**：记录所有被拦截的请求，用于追踪攻击模式。
- **搜索引擎健康 (SEO)**：记录主要搜索引擎（Google, 百度, Bing 等）的所有访问记录。无论其返回 200 还是 404，均进行记录以监控索引健康状态。
- **噪音过滤**：**不记录**来自未知 Agent 或普通用户的常规 404 错误。这可以防止数据库膨胀和看板数据混乱。

## 3. 管理员审计看板

位于 `/admin/dashboard` 的管理中心提供以下视角：

- **安全防御总计**：实时显示 403 拦截次数。
- **搜索引擎监控**：追踪搜索引擎抓取的成功与失败情况。
- **攻击路径深度监控**：识别被最频繁扫描的高危路径。

## 4. 维护说明

- **表清理**：可以随时执行 `TRUNCATE` 清空 `bot_hits` 表以获得干净的审计视图。该表仅用于审计，不影响业务运作。
- **白名单更新**：如需新增允许的工具或爬虫，请同步更新 `proxy.ts` 和 `bot-logger.ts` 中的 `UTILITY_BOTS` 正则表达式。
