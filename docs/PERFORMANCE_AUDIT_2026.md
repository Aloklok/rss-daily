# 基础设施性能审计报告 (Infrastructure Performance Audit)

**日期**: 2026-01-16  
**变更**: Vercel Function 执行区域从 **美国东部 (iad1)** 迁移至 **韩国首尔 (icn1)**

---

## 🚀 核心结论

这是一份非常令人振奋的数据！我们可以直接看到“迁址首尔”带来的质变。通过物理同域（Vercel App 与 Supabase DB 同在首尔），我们成功消除了跨洋网络延迟。

## 📊 数据对比：质的飞跃

| 指标                   | 旧数据 (美国 iad1) | 新数据 (首尔 icn1) | 提升幅度               | 备注                   |
| :--------------------- | :----------------- | :----------------- | :--------------------- | :--------------------- |
| **Full TTFB**          | **1.35 s**         | **966 ms**         | **快了 ~400ms (↓28%)** | 浏览器拿到首字节的时间 |
| **FCP** (首次绘制)     | 2.25 s             | **1.84 s**         | **快了 ~400ms (↓18%)** | 浏览器渲染出首屏内容   |
| **LCP** (最大内容绘制) | 2.28 s             | **1.86 s**         | **快了 ~420ms (↓18%)** | 核心内容（如头图）可见 |
| **TBT** (总阻塞时间)   | 260 ms             | 272 ms             | 基本持平               | JS 执行阻塞主线程      |

---

## 🔍 深度诊断分析

### 1. TTFB 的“天花板”已被捅破

你的 TTFB 从 `1.35s` 降到了 `966ms`。这意味着什么？

- **物理定律验证**：浏览器现在提前了将近 **半秒钟** 拿到了 HTML 源码。这正好对应减去了两次跨太平洋的物理延迟（美国往返）。
- **净处理耗时**：剩余的 `966ms` 说明你的后端逻辑（Supabase 查询 + FreshRSS 同步 + Next.js 渲染）大约需要 **0.5s - 0.7s** 的“净处理时间”。考虑到复杂的 SSR 聚合逻辑，这个速度已经非常扎实。

### 2. 渲染链路：那 0.9s 的“顽疾”依然存在

观察 `FCP - TTFB` 的差值：

- **旧数据**：2.25 - 1.35 = **0.90s**
- **新数据**：1.84 - 0.96 = **0.88s**

**结论**：这个差值几乎没有任何变化。这再次印证了之前的判断：这 `0.9s` 与服务器位置无关，完全是浏览器在处理那 **1.5MB+（解压后）HTML** 和 **135KB JSON** 时的主线程开销（Style Calculation & Layout）。

### 3. LCP 的完美跟随

你的 LCP (`1.86s`) 紧紧贴着 FCP (`1.84s`)。
这说明你的 **图片预加载 (Priority)** 和 **CDN (Cloudflare)** 工作得非常完美。一旦浏览器获准渲染，核心内容瞬间就位，几乎没有额外的资源加载延迟。

---

## 🔮 结论与展望

目前的 **966ms TTFB** 和 **1.84s FCP** 已经是物理层面的最强形态，架构非常稳固。

关于 JSON Payload 的优化（RSC 化）：
经评估，虽然 RSC 可以进一步降低 TBT，但会牺牲**毫秒级客户端筛选**（TimeSlot/Verdict）的极速体验。鉴于当前的性能指标已经非常优秀，且 `__NEXT_DATA__` 中的数据（全部来自 Supabase，不含 FreshRSS 冗余字段）对于交互功能是必需的，我们决定**保持现状**，优先保障交互流畅度。

---

### 地理位置优化的终极推演：Next Stop, Hong Kong?

在"首尔迁址"取得巨大成功后，我们通过日志发现了一个潜在的"重心偏移"现象：
虽然核心数据库 (Supabase) 在首尔，但系统的可用性保护机制 (Fallback) 和部分元数据获取依赖于 **印尼 (Jakarta)** 的 FreshRSS。
且我们的主要目标用户（包括你自己）位于 **香港/中国大陆**。

#### 延迟账本：HKG vs ICN

假设在 **香港** 发起访问，并触发了 3 次串行 FreshRSS 请求（如日志所示）：

| 链路环节                    | 方案 A: Vercel @ Seoul (现状)   | 方案 B: Vercel @ Hong Kong (推演) |
| :-------------------------- | :------------------------------ | :-------------------------------- |
| **User ➔ Vercel**           | 香港 → 首尔 (~45ms)             | 香港同城 (~5ms)                   |
| **Vercel ➔ Supabase** (2次) | 首尔同城 (~2ms)                 | 香港 → 首尔 (~45ms)               |
| **Vercel ➔ FreshRSS** (3次) | 首尔 → 印尼 (~80ms × 3 = 240ms) | 香港 → 印尼 (~40ms × 3 = 120ms)   |
| **Vercel ➔ User**           | 首尔 → 香港 (~45ms)             | 香港同城 (~5ms)                   |
| **理论总耗时 (串行)**       | **~332ms** + 计算耗时           | **~175ms** + 计算耗时             |

#### 结论

**香港 (hkg1)** 可能是比首尔更优的"黄金中转站"。

1.  **几何中心**：它位于 首尔库 和 印尼源 的中间位置，能有效平衡两端的延迟。
2.  **容错红利**：在发生多次串行请求（如 FreshRSS Fallback）时，香港到印尼的低延迟优势会被放大。
3.  **第一公里**：直接覆盖核心用户群，SSL 握手和首字节到达会更快。

> **决策建议**：暂时保持首尔节点稳定运行。若后续需要进一步压榨 TTFB，可尝试将 Vercel 该项目迁移至 `hkg1` 进行 A/B 测试。

## 性能审计案例研究：DNS 与 CDN 架构优化 (2026.01.18)

### 背景

项目最初使用 Cloudflare (CF) 作为 CDN。由于 CF 强制修改控制权 (Nameservers)，导致无法针对中国大陆搜索引擎（百度）进行线路优化，百度蜘蛛经常抓取境外节点导致 SEO 表现不佳。

### 架构演进与尝试

1. **尝试 A: 阿里云 ESA (不含内地套餐) + 阿里云 DNS**
   - **目标**: 利用阿里云 DNS 的线路解析功能，让百度爬虫直连 Vercel IP，普通流量走 ESA 加速。
   - **失败项**: 虽然理论上可行，但在 HTTPS 握手层面遇到了严重的 **504 Gateway Timeout**。
   - **核心教训**:
     - **SNI 是命门**: 在 ESA 这类代理层，如果“回源 SNI”不手动强制设置为项目域名（而误用了源站长域名），Vercel 会因证书匹配失败而拒绝握手。
     - **回源 HOST 改写**: 在 ESA 逻辑中，必须通过规则强制改写回源 HOST 以同步修正 SNI。
     - **套餐地域限制**: “全球 (不包含中国内地)” 套餐意味着国内访问 ESA 境外节点比直连 Vercel 路径更长、握手更重。

2. **最终架构: 阿里云 DNS 解析 + Vercel 全球网络直连**
   - **配置**:
     - **默认线路**: CNAME 直连 Vercel (`cname.vercel-dns.com`)。
     - **百度线路**: A 记录直连 Vercel Anycast IP (`216.198.79.1`)。
   - **优势**:
     - **路径最优**: 减少了 ESA 中转层的 TLS 握手开销，国内/海外访问速度实测达到最优。
     - **SEO 保护**: 百度爬虫直接命中 Vercel 节点，绕过代理干扰。
     - **证书透明**: Vercel 自动管理二级证书，无需在 DNS 侧配置复杂的 ACME 挑战记录。

### 技术资产与复盘

- **不要低估 Vercel Anycast 的质量**: 在不具备全量国内 CDN 节点的情况下，直连 Vercel 通常比使用不带内地的 CDN 代理更稳。
- **DNS 管理权的重要性**: 保留阿里云 DNS 的解析权，比将 Nameservers 迁往 Cloudflare 具有更高的业务灵活性（尤其针对百度 SEO）。
- **ESA 使用门槛**: 对于非备案/非内地套餐，ESA 的主要价值在 WAF 安全防护而非加速；若追求速度，应优先精简请求路径。

## 📊 2026.01.18 深度优化测量：数据隐私与链路精简

### 核心指标变动：数据隐私与链路精简对标

- **Full TTFB (首字节时间)**: **819 ms** (对比 1.16/首尔版 966 ms，提升了 **15%**)
  - _优化点_：通过移除 ESA/CF 代理层，消除了跨境连接中的额外 TLS 握手开销。
- **FCP (首次绘制)**: **1.38 s** (对比 1.16 版 1.84 s，提升了 **25%**)
  - _优化点_：**质变项**。HTML/JSON 体积的大幅缩减（由于剥离了向量数据），使得浏览器解析和首屏渲染速度显著提升。
- **Page Weight (页面体积)**: **591 KB** (对比优化前 **600+ KB**，压缩后体积略有下降)
  - _关键贡献_：虽然压缩后体积变化看似不大，但从源头上成功剥离了庞大的 `embedding` 向量数据（未压缩源码体积显著减小），大幅减轻了浏览器反序列化 JSON 和解析 DOM 的主线程压力。
- **LCP (最大内容绘制)**: **1.89 s** (基本持平)
  - _分析_：主要受网络环境波动影响，核心视觉元素加载依然稳定。
- **TBT (总阻塞时间)**: **305 ms** (略有升高)
  - _分析_：与浏览器主线程任务调度相关，整体交互流畅度依然保持高水准。

### 🔍 深度复盘：不仅仅是变快了

1. **“隐私驱动”的性能红利**：
   通过创建 `articles_view` 解决 `embedding` 数据泄露问题。虽然在 Gzip/Brotli 压缩后传输体积变化（600KB+ -> 591KB）不算剧烈，但**未压缩的 HTML 源码体积**得到了极大精简。这直接减轻了浏览器在 FCP 阶段的“解压-解析-渲染”负担，让页面在 1.38s 即可完成首次有效绘制。

2. **直连协议的胜利**：
   放弃 ESA 这种“中间商”后，TTFB（首字节时间）从近 1s 压缩到了 **819ms**。在没有国内节点支持的情况下，ESA 代理引入的延迟（TTL 查找 + 跨海 TLS 握手）大于它提供的潜在优化。**Vercel Anycast IP 在这种架构下表现出了极强的直接吞吐能力。**

3. **结论**：
   目前的系统状态是**“身轻如燕”**。在物理层（首尔 ICN）和协议层（直连）都已优化到极致的情况下，下一步的优化重点将完全转向前端组件的懒加载（Lazy Loading）和客户端重渲染频率的控制。
